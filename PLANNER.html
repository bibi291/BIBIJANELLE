<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pastel Planner — Goals, Calendar & Reminders</title>

<!-- FullCalendar v5 (bundle) from CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<style>
  /* Pastel aesthetic */
  :root{
    --bg:#FBF8FF;
    --card: rgba(255,255,255,0.9);
    --muted:#8b8794;
    --accent-1: #A8D5E2; /* minty */
    --accent-2: #F6C1D9; /* pink */
    --accent-3: #FDE7B9; /* peach */
    --accent-4: #C9C7FF; /* lavender */
    --radius:18px;
    --glass: rgba(255,255,255,0.75);
    --shadow: 0 8px 30px rgba(87,84,111,0.08);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color-scheme: light;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    background: linear-gradient(180deg,var(--bg) 0%, #FFFDF8 100%);
    padding:28px;
    -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:26px;align-items:start}

  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  h1{margin:0;font-size:20px}
  .today{color:var(--muted);font-size:13px}

  /* Left column (goals) */
  .panel{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
  .search{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(16,24,40,0.05)}
  .controls{display:flex;gap:8px;margin-top:12px}
  .btn{padding:8px 12px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--accent-4), #b1d0ff);color:#2e2b3f;font-weight:700;cursor:pointer}
  .btn.secondary{background:transparent;border:1px solid rgba(16,24,40,0.05)}
  .btn.ghost{background:linear-gradient(90deg,var(--accent-3), #fff2d6)}
  .goal-list{margin-top:14px;display:flex;flex-direction:column;gap:10px;max-height:65vh;overflow:auto;padding-right:6px}
  .goal-item{padding:12px;border-radius:12px;border:1px solid rgba(16,24,40,0.03);cursor:pointer;background:linear-gradient(180deg,rgba(255,255,255,0.7), rgba(255,255,255,0.5))}
  .goal-item.selected{box-shadow:0 8px 20px rgba(110,103,210,0.11);outline:2px solid rgba(110,103,210,0.08)}
  .muted{color:var(--muted);font-size:13px}

  /* main column */
  .main{background:var(--card);padding:20px;border-radius:20px;box-shadow:var(--shadow)}
  .grid-2{display:grid;grid-template-columns:1fr 340px;gap:18px}
  .title-input{font-size:20px;font-weight:700;border:0;background:transparent;outline:none;width:100%}
  .desc{margin-top:8px;height:84px;border-radius:12px;padding:10px;border:1px solid rgba(16,24,40,0.06);resize:vertical}
  .meta-row{display:flex;gap:8px;margin-top:12px}
  .card{padding:12px;border-radius:12px;border:1px solid rgba(16,24,40,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.9), rgba(255,255,255,0.8))}
  .tasks{margin-top:14px}
  .task-row{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;border:1px solid rgba(16,24,40,0.03)}
  .task-row input[type="checkbox"]{width:18px;height:18px}
  .task-title{flex:1}
  .small{font-size:13px;color:var(--muted)}

  /* calendar area */
  #calendar{background:transparent;border-radius:12px;padding:6px}
  .fc .fc-toolbar-title{font-weight:700}
  .fc-event{border-radius:10px;opacity:0.95}

  /* toast */
  .toast{position:fixed;right:20px;bottom:20px;background:white;padding:12px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(20,20,60,0.15);display:flex;gap:12px;align-items:center;z-index:9999}
  .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,var(--accent-1), var(--accent-4))}

  footer{margin-top:16px;display:flex;justify-content:space-between;align-items:center}
  .tiny{font-size:13px;color:var(--muted)}
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr; padding:12px}
    .grid-2{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<div class="wrap">
  <div>
    <header>
      <h1>Pastel Planner</h1>
      <div class="today" id="today"></div>
    </header>

    <div class="panel">
      <input type="search" id="search" class="search" placeholder="Search goals..." />
      <div class="controls">
        <button id="quickAdd" class="btn">Quick Add</button>
        <button id="newGoal" class="btn secondary">New</button>
      </div>

      <div class="goal-list" id="goalList"></div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="exportBtn" class="btn secondary">Export</button>
        <button id="importToggle" class="btn secondary">Import</button>
        <button id="resetBtn" class="btn ghost">Reset</button>
      </div>

      <div id="importArea" style="margin-top:12px;display:none">
        <textarea id="importText" style="width:100%;height:90px;border-radius:10px;padding:8px;border:1px solid rgba(16,24,40,0.05)"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="doImport" class="btn">Import JSON</button>
          <button id="cancelImport" class="btn secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <main class="main">
    <div id="noSelection" style="text-align:center;padding:40px">
      <h2 style="margin:0 0 8px 0">No goal selected</h2>
      <p class="muted" style="margin:0">Add or pick a goal to manage tasks and reminders.</p>
    </div>

    <div id="editor" style="display:none">
      <div class="grid-2">
        <div>
          <input id="goalTitle" class="title-input" placeholder="Goal title" />
          <textarea id="goalDesc" class="desc" placeholder="Describe the goal..."></textarea>

          <div class="meta-row">
            <input type="date" id="goalDeadline" class="card" />
            <input type="number" id="goalWeekly" min="0" class="card" placeholder="Hours/week" />
            <select id="goalImportance" class="card">
              <option value="1">Importance 1</option>
              <option value="2">Importance 2</option>
              <option value="3" selected>Importance 3</option>
              <option value="4">Importance 4</option>
              <option value="5">Importance 5</option>
            </select>
          </div>

          <section class="tasks">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3 style="margin:0">Tasks <span id="taskSummary" class="small"></span></h3>
              <div style="display:flex;gap:8px">
                <input id="taskText" placeholder="Task title" style="padding:8px;border-radius:10px;border:1px solid rgba(16,24,40,0.05)" />
                <input id="taskDate" type="datetime-local" style="padding:8px;border-radius:10px;border:1px solid rgba(16,24,40,0.05)" />
                <button id="addTaskBtn" class="btn">Add</button>
              </div>
            </div>

            <div id="tasksList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px"></div>
          </section>

        </div>

        <aside>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small">Progress</div>
                <div id="progressPercent" style="font-size:22px;font-weight:700">0%</div>
              </div>
              <div>
                <button id="deleteGoal" class="btn ghost">Delete</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <div class="small">Calendar</div>
              <div id="calendar" style="margin-top:8px"></div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px">
              <button id="exportGoalJson" class="btn secondary">Copy Goal JSON</button>
              <button id="exportIcs" class="btn secondary">Download .ics</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="small">Suggestions</div>
            <ul id="suggestions" style="margin-top:8px;margin-left:18px;color:#555"></ul>
          </div>
        </aside>
      </div>

      <footer>
        <div class="tiny">Saved locally in your browser (localStorage). Export to backup.</div>
        <div style="display:flex;gap:8px">
          <button id="saveBtn" class="btn secondary">Save</button>
          <button id="autoplan" class="btn">Auto-Plan Tasks</button>
        </div>
      </footer>
    </div>
  </main>
</div>

<!-- toast container -->
<div id="toastContainer" style="position:fixed;right:20px;bottom:20px;z-index:9999"></div>

<script>
/* === Planner with Calendar + Notifications ===
   Save as index.html and open. Allow notifications when prompted.
   Reminder: Browser notifications work best while the page is open.
*/

const LS_KEY = 'pastel_planner_v2';
function uid(){ return Math.random().toString(36).slice(2,9) }
function nowISO(){ return (new Date()).toISOString() }

/* --- Minimal data model --- */
const state = {
  goals: JSON.parse(localStorage.getItem(LS_KEY) || '[]'),
  selectedId: null,
  notifiedEventIds: new Set(), // track which reminders have fired
};

/* --- UI refs --- */
const todayEl = document.getElementById('today');
const goalList = document.getElementById('goalList');
const search = document.getElementById('search');
const quickAdd = document.getElementById('quickAdd');
const newGoal = document.getElementById('newGoal');
const exportBtn = document.getElementById('exportBtn');
const resetBtn = document.getElementById('resetBtn');
const importToggle = document.getElementById('importToggle');
const importArea = document.getElementById('importArea');
const importText = document.getElementById('importText');
const doImport = document.getElementById('doImport');
const cancelImport = document.getElementById('cancelImport');

const noSelection = document.getElementById('noSelection');
const editor = document.getElementById('editor');

const goalTitle = document.getElementById('goalTitle');
const goalDesc = document.getElementById('goalDesc');
const goalDeadline = document.getElementById('goalDeadline');
const goalWeekly = document.getElementById('goalWeekly');
const goalImportance = document.getElementById('goalImportance');

const taskText = document.getElementById('taskText');
const taskDate = document.getElementById('taskDate');
const addTaskBtn = document.getElementById('addTaskBtn');
const tasksList = document.getElementById('tasksList');
const taskSummary = document.getElementById('taskSummary');

const progressPercent = document.getElementById('progressPercent');

const saveBtn = document.getElementById('saveBtn');
const deleteGoal = document.getElementById('deleteGoal');
const exportGoalJson = document.getElementById('exportGoalJson');
const exportIcs = document.getElementById('exportIcs');
const autoplan = document.getElementById('autoplan');
const suggestionsEl = document.getElementById('suggestions');

const toastContainer = document.getElementById('toastContainer');

todayEl.textContent = new Date().toLocaleDateString();

/* --- Helpers --- */
function save() {
  localStorage.setItem(LS_KEY, JSON.stringify(state.goals));
  render();
}

function createGoal(title='New Goal', deadline=null, importance=3, weeklyHours=3) {
  return {
    id: uid(),
    title,
    description: '',
    createdAt: new Date().toISOString(),
    deadline,
    importance,
    weeklyHours,
    tasks: [], // {id, title, datetime (ISO), done, reminderMinutes, notified}
    plan: [] // not used heavily here but reserved
  };
}

function findGoal(id){ return state.goals.find(g=>g.id===id) }

function goalProgress(g){
  if(!g || !g.tasks.length) return 0;
  const done = g.tasks.filter(t=>t.done).length;
  return Math.round((done/g.tasks.length)*100);
}

/* --- Render --- */
function renderGoalList() {
  const q = (search.value||'').toLowerCase();
  goalList.innerHTML = '';
  const filtered = state.goals.filter(g => g.title.toLowerCase().includes(q));
  if(filtered.length===0) {
    const el = document.createElement('div'); el.className='muted'; el.style.padding='14px'; el.textContent = 'No goals yet — add one!';
    goalList.appendChild(el);
    return;
  }
  filtered.forEach(g=>{
    const div = document.createElement('div');
    div.className = 'goal-item' + (g.id===state.selectedId ? ' selected' : '');
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600">${escapeHtml(g.title)}</div>
          <div class="muted" style="font-size:12px">${g.deadline||'No deadline'}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">${goalProgress(g)}%</div>
          <div class="muted" style="font-size:12px">${g.weeklyHours || 0}h/wk • ⭐${g.importance || 3}</div>
        </div>
      </div>
      <div style="margin-top:8px;color:#555;font-size:13px">${escapeHtml((g.description||'').slice(0,80))}${(g.description||'').length>80?'…':''}</div>
    `;
    div.addEventListener('click', ()=> {
      state.selectedId = g.id;
      openEditor();
      render();
    });
    goalList.appendChild(div);
  });
}

function renderEditor() {
  const g = findGoal(state.selectedId);
  if(!g){ editor.style.display='none'; noSelection.style.display='block'; return; }
  noSelection.style.display='none'; editor.style.display='block';

  goalTitle.value = g.title;
  goalDesc.value = g.description;
  goalDeadline.value = g.deadline || '';
  goalWeekly.value = g.weeklyHours || 0;
  goalImportance.value = g.importance || 3;

  // tasks
  tasksList.innerHTML = '';
  g.tasks.slice().reverse().forEach(t=>{
    const row = document.createElement('div');
    row.className = 'task-row';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!t.done;
    chk.addEventListener('change', ()=>{ t.done = chk.checked; save(); });
    const title = document.createElement('div'); title.className='task-title'; title.textContent = `${t.title} ${t.datetime ? ' — ' + formatLocal(t.datetime) : ''}`;
    if(t.done) title.style.textDecoration = 'line-through';
    const remBtn = document.createElement('button'); remBtn.className='btn secondary'; remBtn.style.padding='6px 8px'; remBtn.textContent='Remove';
    remBtn.addEventListener('click', ()=>{ g.tasks = g.tasks.filter(x=>x.id!==t.id); save(); });
    const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.style.padding='6px 8px'; editBtn.textContent='Edit';
    editBtn.addEventListener('click', ()=> openTaskEditor(g, t));
    row.appendChild(chk); row.appendChild(title); row.appendChild(editBtn); row.appendChild(remBtn);
    tasksList.appendChild(row);
  });
  taskSummary.textContent = `${g.tasks.length} items • ${goalProgress(g)}% done`;

  progressPercent.textContent = goalProgress(g) + '%';

  // suggestions
  suggestionsEl.innerHTML = '';
  suggestionsFor(g).forEach(s=>{
    const li = document.createElement('li'); li.textContent = s; suggestionsEl.appendChild(li);
  });

  // update calendar events
  refreshCalendarEvents();
}

/* --- Small helpers --- */
function formatLocal(iso){
  if(!iso) return '';
  const d = new Date(iso);
  return d.toLocaleString();
}
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* --- Event handling / UI wiring --- */
search.addEventListener('input', renderGoalList);
quickAdd.addEventListener('click', ()=>{
  const g = createGoal('Study — Quick Add', null, 4, 6);
  state.goals.unshift(g); state.selectedId = g.id; save();
});
newGoal.addEventListener('click', ()=>{
  const g = createGoal('New Goal', new Date().toISOString().slice(0,10), 3, 3);
  state.goals.unshift(g); state.selectedId = g.id; save();
});
exportBtn.addEventListener('click', ()=>{
  const data = { exportedAt: new Date().toISOString(), goals: state.goals };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'planner_export.json'; a.click();
  URL.revokeObjectURL(url);
});
resetBtn.addEventListener('click', ()=>{
  if(!confirm('Reset planner and delete all goals?')) return;
  state.goals = []; state.selectedId = null; localStorage.removeItem(LS_KEY); render();
});
importToggle.addEventListener('click', ()=> importArea.style.display = importArea.style.display==='none' ? 'block' : 'none');
doImport.addEventListener('click', ()=>{
  try {
    const parsed = JSON.parse(importText.value);
    if(parsed.goals) state.goals = parsed.goals;
    else if(Array.isArray(parsed)) state.goals = parsed;
    else throw new Error('format');
    state.selectedId = state.goals[0] ? state.goals[0].id : null;
    importText.value=''; importArea.style.display='none'; save();
  } catch(e){ alert('Invalid JSON'); }
});
cancelImport.addEventListener('click', ()=>{ importText.value=''; importArea.style.display='none'; });

goalTitle.addEventListener('input', ()=>{ const g=findGoal(state.selectedId); if(g){ g.title = goalTitle.value; save(); }});
goalDesc.addEventListener('input', ()=>{ const g=findGoal(state.selectedId); if(g){ g.description = goalDesc.value; save(); }});
goalDeadline.addEventListener('change', ()=>{ const g=findGoal(state.selectedId); if(g){ g.deadline = goalDeadline.value || null; save(); }});
goalWeekly.addEventListener('change', ()=>{ const g=findGoal(state.selectedId); if(g){ g.weeklyHours = Number(goalWeekly.value)||0; save(); }});
goalImportance.addEventListener('change', ()=>{ const g=findGoal(state.selectedId); if(g){ g.importance = Number(goalImportance.value)||3; save(); }});

addTaskBtn.addEventListener('click', ()=> addTaskFromInputs());
taskText.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') addTaskFromInputs(); });

function addTaskFromInputs(){
  const g = findGoal(state.selectedId);
  if(!g) return alert('Select a goal first');
  const title = (taskText.value||'').trim(); if(!title) return;
  const dt = taskDate.value ? new Date(taskDate.value).toISOString() : null;
  const task = { id: uid(), title, datetime: dt, done: false, reminderMinutes: 5, notified: false };
  g.tasks.push(task);
  taskText.value=''; taskDate.value=''; save();
}

function openTaskEditor(goal, task){
  // simple prompt-based edit UI
  const newTitle = prompt('Task title', task.title);
  if(newTitle === null) return;
  task.title = newTitle;
  const dtInput = prompt('Task date/time as ISO or empty (e.g., 2025-08-10T14:00)', task.datetime || '');
  if(dtInput === null) return;
  task.datetime = dtInput.trim() || null;
  const rem = prompt('Reminder minutes before (default 5)', String(task.reminderMinutes||5));
  if(rem !== null) task.reminderMinutes = Math.max(0, parseInt(rem) || 0);
  save();
}

/* --- Delete & export goal --- */
deleteGoal.addEventListener('click', ()=>{
  if(!confirm('Delete this goal?')) return;
  state.goals = state.goals.filter(g=>g.id !== state.selectedId);
  state.selectedId = state.goals[0] ? state.goals[0].id : null;
  save();
});

exportGoalJson.addEventListener('click', ()=>{
  const g = findGoal(state.selectedId);
  if(!g) return;
  navigator.clipboard.writeText(JSON.stringify(g,null,2)).then(()=> alert('Goal JSON copied to clipboard'));
});

/* --- Tiny ICS export for a goal (basic) --- */
exportIcs.addEventListener('click', ()=>{
  const g = findGoal(state.selectedId);
  if(!g) return alert('No goal selected');
  const events = g.tasks.filter(t=>t.datetime).map(t=>{
    const dt = new Date(t.datetime);
    function toIcsDate(d){ return d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z' }
    return `BEGIN:VEVENT
UID:${t.id}@pastelplanner
DTSTAMP:${toIcsDate(new Date())}
DTSTART:${toIcsDate(dt)}
SUMMARY:${escapeIcs(t.title)}
DESCRIPTION:Goal: ${escapeIcs(g.title)}
END:VEVENT`;
  }).join('\n');
  const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//PastelPlanner//EN
${events}
END:VCALENDAR`;
  const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = (g.title.replace(/\s+/g,'_').slice(0,30)||'goal') + '.ics'; a.click();
  URL.revokeObjectURL(url);
});

function escapeIcs(s){ return (s||'').replace(/\n/g,'\\n').replace(/,/g,'\\,') }

/* --- Auto-plan sample --- */
autoplan.addEventListener('click', ()=>{
  const g = findGoal(state.selectedId); if(!g) return;
  g.tasks.push({id:uid(), title:'Define milestone 1', datetime:null, done:false, reminderMinutes:5, notified:false});
  g.tasks.push({id:uid(), title:'Schedule 2 focus sessions', datetime:null, done:false, reminderMinutes:5, notified:false});
  save();
});

/* --- Suggestions --- */
function suggestionsFor(g){
  const s=[];
  if(g.weeklyHours >= 7) s.push('Try 3 focused Pomodoro sessions on weekdays.');
  if(g.importance >= 4) s.push('Block 2 hours on your calendar this week for deep work.');
  if(!g.deadline) s.push('Set a deadline to make the plan actionable.');
  if(g.tasks.length < 4) s.push('Add 2–3 concrete tasks that take <2 hours each.');
  return s;
}

/* === FullCalendar setup === */
let calendar;
function initCalendar(){
  const calendarEl = document.getElementById('calendar');
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 500,
    headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,listWeek' },
    selectable: true,
    dateClick: function(info){
      // clicking a date => create a new task with that date
      const g = findGoal(state.selectedId);
      if(!g){ alert('Select a goal first'); return; }
      const title = prompt('Task title for ' + info.dateStr);
      if(!title) return;
      // set time to midday by default
      const dt = new Date(info.dateStr + 'T12:00').toISOString();
      g.tasks.push({ id: uid(), title, datetime: dt, done:false, reminderMinutes:5, notified:false });
      save();
    },
    eventClick: function(info){
      // event clicked => open edit prompt
      const g = findGoal(state.selectedId);
      if(!g) return;
      const evId = info.event.id;
      const task = g.tasks.find(t=>t.id===evId);
      if(task) openTaskEditor(g, task);
    }
  });
  calendar.render();
  refreshCalendarEvents();
}

/* update events on calendar from selected goal */
function refreshCalendarEvents(){
  if(!calendar) return;
  calendar.getEvents().forEach(e=> e.remove());
  const g = findGoal(state.selectedId);
  if(!g) return;
  g.tasks.forEach(t=>{
    if(t.datetime){
      const ev = calendar.addEvent({
        id: t.id,
        title: t.title + (t.done ? ' ✓' : ''),
        start: t.datetime,
        allDay: false,
        backgroundColor: t.done ? '#DDE6FF' : undefined,
      });
    }
  });
}

/* === Notifications / reminder engine === */
let notificationsGranted = false;

async function requestNotificationPermission(){
  if(!('Notification' in window)) return false;
  if(Notification.permission === 'granted'){ notificationsGranted = true; return true; }
  if(Notification.permission === 'denied') { notificationsGranted = false; return false; }
  const p = await Notification.requestPermission();
  notificationsGranted = (p === 'granted');
  return notificationsGranted;
}

function showToast(title, text){
  const div = document.createElement('div'); div.className='toast';
  div.innerHTML = `<div class="dot"></div><div><div style="font-weight:700">${escapeHtml(title)}</div><div style="font-size:13px;color:#444">${escapeHtml(text)}</div></div>`;
  toastContainer.appendChild(div);
  setTimeout(()=>{ div.style.transition='opacity 0.4s'; div.style.opacity='0'; setTimeout(()=>div.remove(),400)}, 7000);
}

function checkReminders(){
  const now = Date.now();
  state.goals.forEach(g=>{
    g.tasks.forEach(t=>{
      if(!t.datetime) return;
      if(t.notified) return; // already fired
      const taskTime = new Date(t.datetime).getTime();
      const remindBefore = (t.reminderMinutes || 5) * 60 * 1000;
      const triggerAt = taskTime - remindBefore;
      // if current time passed trigger and task is not done => notify
      if(now >= triggerAt && now <= taskTime + 60*1000 && !t.done){
        // create browser notification
        if(notificationsGranted){
          try {
            const n = new Notification(g.title + ' — ' + t.title, {
              body: (t.datetime ? 'Due: ' + formatLocal(t.datetime) : '') + (t.reminderMinutes ? ' (reminder)' : ''),
              tag: t.id
            });
            n.onclick = ()=> window.focus();
          } catch(e){ /* ignore */ }
        }
        // toast
        showToast(g.title, t.title + (t.datetime ? ' — ' + formatLocal(t.datetime) : ''));
        t.notified = true;
        save();
      }
    });
  });
}

/* Run checkReminders every 30s and on load */
setInterval(checkReminders, 30*1000);

/* Ask for permission on load */
requestNotificationPermission();

/* === Boot === */
function render(){
  renderGoalList();
  renderEditor(); // will hide if no selection
}
function openEditor(){
  if(!state.selectedId && state.goals.length) state.selectedId = state.goals[0].id;
  render();
}

if(!state.goals.length){
  // seed example
  const ex = createGoal('Learn Anatomy', null, 5, 8);
  ex.description = 'Use spaced repetition and weekly practice.';
  ex.tasks.push({id:uid(), title:'Read chapter 1', datetime: null, done:false, reminderMinutes:5, notified:false});
  ex.tasks.push({id:uid(), title:'Practice flashcards', datetime: null, done:false, reminderMinutes:10, notified:false});
  state.goals.push(ex);
  state.selectedId = ex.id;
}
initCalendar();
render();
checkReminders();

/* Save hook for UI */
saveBtn.addEventListener('click', ()=>{ save(); alert('Saved (localStorage).') });

/* Refresh calendar on storage changes (useful if multiple tabs) */
window.addEventListener('storage', (e)=> {
  if(e.key === LS_KEY){
    state.goals = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    render();
  }
});

/* Refresh calendar events when state changes */
const originalSave = save;
save = function(){
  localStorage.setItem(LS_KEY, JSON.stringify(state.goals));
  renderGoalList();
  renderEditor();
  refreshCalendarEvents();
  checkReminders();
}

/* utility: refresh events every time slot changes */
setInterval(()=> refreshCalendarEvents(), 10*1000);

</script>
</body>
</html>
